# Скрипт для нагрузки IBM MQ

## Основные положения

- скрипт асинхронный - запись и чтение сообщений происходят в разных тред группах

- скрипт может работать одновременно с несколькими серверами MQ

- скрипт получает адреса MQ из GitLab. Есть возможность получать координаты разных стендов через выбор maven профиля при запуске теста

- регулирование нагрузки производится передачей параметров при запуске скрипта. Рассчет данных параметров производится следующим образом:

  > L - подаваемая нагрука (сообщения в секунду, TPS). Первичный параметр, служит для рассчета количетва тредов
  >
  > P - пейсинг, передаеся при запуске. Опытным путем определено рекомендованное значение - 50 мс, при передаче в скрипт нормируется на секунду - 0.05
  >
  > T - количество потоков, передается при запуске
  >
  > n - количество серверов MQ. Определяется при получении адресов MQ из GitLab
  >
  > `T = L / (1/P) = L * P`
  >
  > Рассчитывать треды и пейсинг нужно исходя из подаваемой нагрузки без учета количества MQ. Нагрузка равномерно распределяется на все нагружаемые сервера очередей. Для этого внутри скрипта происходит перерасчет пейсинга и количетсва потоков
  >
  > `Tскрипт = T * n`
  >
  > `Pскрипт = P * n`

- измерение времени отклика происходит с помощью мапы *Correlation ID : Timestamp*. При отсутствии ответных сообщений мапа будет расти и не будет очищаться, что может привести к утечке памяти

- скрипт экспортирует метрики теста для сборки с помощью Prometheus

- для отправки сообщений в скрипте используется две тред группы: одна запускается при генерации нагрузки, другая служит для дебага в режиме gui

- тред группа консьюмера работает без пейсинга с постоянным количеством потоков на каждый сервер MQ

- в скрипте присутсвует тред группа для измерения глубины очереди

## Запуск нагрузки

Пример команды запуска теста:

```bash
mvn clean jmeter:configure jmeter:jmeter -DselectConfiguration=default-cli -Dthreads=10 -Dpacing=0.05 -DstepsCount=10 -DrumpUpTime=10 -Dduration=60 -Ddebug=0 -DrunId=1 -Prapid
```

где

`jmeter:configure jmeter:jmeter -DselectConfiguration=default-cli` - сборка и запуск JMeter с помощью [jmeter-maven-plugin](https://github.com/jmeter-maven-plugin/jmeter-maven-plugin)

`-Dthreads=10 -Dpacing=0.05` - параметры для регулирования целевой нагрузки, описаны выше

`-DstepsCount=10 -DrumpUpTime=10` - параметры, регулирующие количество ступеней и время выхода на целевую нагрузку. Нужны для настройки тред группы [Concurrency Thread Group](https://jmeter-plugins.org/wiki/ConcurrencyThreadGroup/)

`-Dduration=60` - время работы теста после выхода на целевую нагрузку

`-Ddebug=0` - отключение тред группы **Debug**

`-DrunId=1` - ID теста для удобства мониторинга

`-Prapid` - выбор maven-профиля для получения координат нужного стенда

## Детали реализации

- в тред группе **setUp** происходит инициализация теста:

  - получение координат стенда из GitLab

  - создание коннекта к каждому серверу MQ для чтения и записи сообщений

  - создание подключения к менеджеру очередей каждого сервера MQ для измерения глубины очереди

  - создание мапы для измерения времени отклика

  - создание шаблона сообщения

  - создание коллектора для обработки метрики глубины очереди

- в тред группе **tearDown** происходит:

  - очистка используемых очередей на всех серверах MQ

  - закрытие всех коннекты

  - очистка мапы с таймстемпами отправки сообщений

- в тред группе **Queue Depth** раз в секунду происходит опрос очередей на количество сообщений. Данные записываются в метрику *jmeter_queue_depth* с лейблами очереди и сервера MQ

- тред группа **UC*XX*** служит для проведения теста и активируется при передаче параметров нагрузки. Особенности:

  - количество потоков и пейсинг рассчитывается исходя из количества нагружаемых серверов MQ

  - каждый поток использует подключение к своему серверу MQ. Пример:

    > `L = 100 TPS`
    >
    > `p = 0.05 (50 мс)`
    >
    > `T = 5`
    >
    > `n = 2`
    >
    > В скрипте произойдет перерасчет, учитывающий количество серверов MQ:
    >
    > `p = 0.1`
    >
    > `T = 10`
    >
    > При запуске теста каждый поток будет подключаться к новому серверу MQ, цикличесики перебирая доступные соединения, т.е. первый поток будет подключаться к первому серверу, второй - ко второму, третий - снова к первому и т.д.

  - чтобы избежать дублирования кода, тред группа **UC*XX*** ссылается на код из тред группы **Debug**

- тред группа **Debug** содержит код отправки сообщения в очередь и служит для отладки скрипта в режиме gui. Особенности:

  - каждый поток при инициализации создает отдельную сессию для работы с очередью

  - происходит формирование и отправка запроса

  - режим записи сообщений по умолчанию - NON PERSISTENT

  - фиксируется Correlation ID сообщения и время отправки в очередь. Таймстемп берется из очереди

- тред группа **Consumer**:

  - интенсивность работы не регулируется. По умолчанию к кажому серверу MQ подключается 5 потоков, без перерыва опрашивающих очередь на наличие новых сообщений

  - как и в тред группе **UC*XX***, каждый поток использует подключение к своему серверу MQ

  - каждый поток создает свою сессию для работы с очередью

  - при вычитывании сообщения из очереди, в мапе происходит поиск таймстемпа отправки соответствующего запроса по CorrelationID. Если таймстемп найден, то разница между временем помещения сообщения в очередь запросов и временем помещения сообщения в очередь ответов записывается как время отклика. Иначе записывается 0
